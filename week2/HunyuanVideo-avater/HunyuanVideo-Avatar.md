![[Pasted image 20250624224031.png]]
### Projection层
通过线性/非线性变化对附属的token做投影,实现它们的语义对齐

图像repeat出来的t_r和视频的t_noise,t_r作为附属token,其语义和t_noise有很大的不同,t_r是静态脸而t_noise是动态运动,后续我们如果直接做element-wise add的话可能会出现语义对齐问题

### RoPE
**简单理解**：RoPE就像给每个数据点贴上一个"位置标签"，告诉模型这个点在时间、宽度、高度三个维度中的确切位置。
RoPE使用复数旋转来表示位置关系，就像时钟指针一样，不同位置对应不同的旋转角度。

1. 原始HunyuanVideo的做法
```
RoPE(l,i,j) - 直接对视频的每一帧每个像素位置进行编码
```

2. 身份信息传播的改进
论文中的关键创新在于处理身份图像：
**位置安排**：
- 将身份图像放在"-1帧"（即第0帧之前的虚拟帧）
- 这样做的目的是让身份信息能够有效地传播到后续的视频帧中
**空间偏移技术**：
```
RoPE_zI(l,i,j) = RoPE(-1, i+w, j+h)
```
这里的关键点：
- **时间维度**：-1（表示在视频开始前）
- **空间偏移**：i+w, j+h（在原始位置基础上加上偏移量w和h）

为什么要这样设计？
1. 防止简单复制粘贴
空间偏移的作用就像"打乱"身份图像的位置信息，防止模型偷懒，直接把身份图像复制到生成的视频帧中。

2. 保持身份一致性
通过将身份图像放在-1帧，模型可以在生成每一帧时都"参考"这个身份信息，确保生成的人物保持一致的外观特征。

形象比喻
可以把这个过程想象成：
1. **身份图像**就像一张"身份证照片"，放在时间轴的最前面
2. **空间偏移**就像把这张照片稍微"移位"，避免模型直接抄袭
3. **时间传播**就像这张身份证在整个视频制作过程中一直被参考，确保生成的每一帧都是"同一个人"

实际效果
这种设计让模型能够：
- 理解并保持人物的身份特征
- 在不同帧之间保持外观一致性
- 避免生成结果中出现身份混乱或不连贯的问题
这就是为什么这种改进的RoPE编码对于身份一致的视频生成如此重要的原因。

w和h是tensor，每个像素的偏移可能不同

**RoPE_zI应该是在Transformer的attention层中与原始3D RoPE并行或混合使用**。

在视频生成中，3D RoPE的作用是：

时间一致性
- **帧间关系**：告诉模型第t帧和第t+1帧的时间关系
- **运动连续性**：保证生成的动作在时间上平滑过渡

空间结构
- **像素邻接关系**：保持图像内部的空间结构
- **几何一致性**：确保物体形状和位置的合理性

时空耦合
- **运动轨迹**：结合时间和空间信息来建模物体运动
- **场景连贯性**：保持整个视频场景的一致性

| 编码类型      | 作用     | 时间维度            | 空间维度          |
| --------- | ------ | --------------- | ------------- |
| 原始3D RoPE | 视频时空结构 | 连续帧序列(0,1,2...) | 原始位置(i,j)     |
| RoPE_zI   | 身份信息传播 | 固定参考(-1)        | 偏移位置(i+w,j+h) |

RoPE_zI对时间一致性的贡献不如原来的RoPE

### Flow Matching
ODE sampling
预测速度场
![[Pasted image 20250626172357.png]]

### Character Image Injection Module

![[Pasted image 20250626172521.png]]

![[Pasted image 20250626172436.png]]


### Face-aware Audio Adapter

we **pad the audio feature sequence prior to the initial frame**

我看到了在latent feather中应该是有2帧是padding的,一个初始的未压缩的帧还有一个identity,这些帧对应的是无意义的audio frame,在数学关系上是一一对应的

|video latent frame|含义|audio frame 来源|是否padding|
|---|---|---|---|
|Frame 0|identity 图像|前面 padding 音频帧（无语音）|✅ 是 padding|
|Frame 1|原始首帧（未压缩）|也是 padding 音频帧|✅ 是 padding|
|Frame 2|压缩后帧 1|来自原始语音|❌ 有效|
|Frame 3|压缩后帧 2|来自原始语音|❌ 有效|
|...|...|...|...|

|项|说明|
|---|---|
|identity latent|来自 identity image，结构上不是 noise/padding，但没有 audio 语义，是“语音驱动无效帧”|
|初始帧 latent|来自首帧，实际是视频中真实的一帧，但由于对齐的 audio 是 padding，所以从 audio 驱动角度是“无语义帧”|

所以为什么需要有一个未压缩的初始帧 latent?需要一个identity我还知道是为了保证视频的身份一致性,但是这个未压缩的初始帧是干什么的?

| 帧索引  | 内容             | 作用                       | 对应 audio |
| ---- | -------------- | ------------------------ | -------- |
| 0    | Identity Image | 保证身份一致性                  | padding  |
| 1    | 原始首帧（未压缩）      | 提供起点 pose、空间细节、时间 anchor | padding  |
| 2... | 3D VAE 压缩帧     | 模拟运动、变化（主干序列）            | 有效音频驱动   |
